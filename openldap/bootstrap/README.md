# Bootstrapping an OpenLDAP Server

This document suggests a method for configuring a basic OpenLDAP 2.4 server
with enough of a directory tree to work with the illumos LDAP client.  The
focus of this deployment is strictly for testing on a private network (i.e.,
not on the Internet).

The directory tree will be anchored at `o=test`, with a NIS domain name object
for the `test` NIS domain.  The directory manager account will be `cn=root`
with password `secret`.  It is assumed that you will call your LDAP server
`ldaptesting.example.com`, most likely via
[hosts(4)](https://illumos.org/man/4/hosts) entries or local DNS.

## File System Layout

The sample files in this directory assume you are going to use `/data/ldap` as
the root directory for OpenLDAP data.

* Start by copying the `schema/*.ldif` files from your OpenLDAP distribution
  into the `/data/ldap/schema` directory; e.g.,
  `/data/ldap/schema/cosine.ldif`, etc.

* Ensure an empty `/var/empty` directory exists, owned `root:root` with mode
  `0755`.

## Bootstrap Configuration

We will use the dynamic runtime configuration engine, where directory server
configuration is itself stored in the LDAP database under `cn=config`.  First,
we need to produce an LDIF file with the initial contents of the configuration
database.  See [config.ldif](config.ldif) in this directory.

Install this file at `/data/ldap/bootstrap/config.ldif`, then:

```
slapadd -F /data/ldap/config -v -n 0 -l /data/ldap/bootstrap/config.ldif
```

This command will create the configuration database at `/data/ldap/config`
using the contents of the LDIF file as a seed.  You can test the new
configuration database (ID 0), as well as the `cn=root` synthetic database (ID
1):

```
slaptest -F /data/ldap/config -v -n 0
slaptest -F /data/ldap/config -v -n 1
```

If you have been operating as the `root` user, you will need to ensure the
`/data/ldap` tree has the correct ownership for the OpenLDAP process; e.g., via
`chown -R slapd:ldap /data/ldap`.

## Start the OpenLDAP Daemon

This part depends on where you obtained your OpenLDAP server package.  I was
using the `openldap-server` pkgsrc package, which included an SMF manifest.
I was able to adjust that manifest like so:

```
svccfg -s openldap-server setprop start/exec = astring: \
    '"'/opt/local/libexec/slapd -u slapd -g ldap \
    -h '\"'ldap://ldaptesting.example.com'\"' \
    -F '\"'/data/ldap/config'\""'
svcadm refresh openldap-server
```

Your system may differ, but the goal is to ensure you are invoking `slapd` with
`-F /data/ldap/config`, to ensure the daemon is using the correct configuration
database.

## Initial Directory Contents

Once your LDAP server is running, you should be able to load the sample contents
from [dit.ldif](dit.ldif):

```
ldapadd -x -h ldaptesting.example.com -D cn=root -w secret -f dit.ldif
```

Note that these flags are for the `ldapadd` program shipped with OpenLDAP,
rather than the one shipped in illumos.  In addition, `dit.ldif` encodes the
hostname `ldaptesting.example.com` and the directory tree `o=test`; if those
are not correct for your testing you will need to modify that file.

## Configuring the illumos LDAP Client

Use [ldapclient(1M)](https://illumos.org/man/1M/ldapclient) to initialise the
LDAP client configuration:

```
ldapclient -v init \
    -a profileName=default \
    -a domainName=test \
    -a proxyDN=cn=proxy,ou=proxies,o=test \
    -a proxyPassword=proxy \
    \
    ldaptesting.example.com
```

Note that this will remove DNS from the Name Service Switch (NSS)
configuration.  If you need DNS, you'll have to add it back to the `hosts:` and
`ipnodes:` entries in `/etc/nsswitch.conf` after running this command.

You can check on the status of the LDAP cache manager service:

```
# /usr/lib/ldap/ldap_cachemgr -g

cachemgr configuration:
server debug level          0
server log file "/var/ldap/cachemgr.log"
number of calls to ldapcachemgr        416

cachemgr cache data statistics:
Configuration refresh information: 
  Previous refresh time: 2018/09/23 22:46:50
  Next refresh time:     2018/09/23 22:47:20
Server information: 
  Previous refresh time: 2018/09/23 22:46:50
  Next refresh time:     2018/09/23 22:47:30
  server: ldaptesting.example.com, status: UP
Cache data information: 
  Maximum cache entries:          256
  Number of cache entries:          0
```

Note that although you should not edit this file directory, you can inspect
the configuration that was loaded from the profile object we imported via `dit.ldif`:

```
# cat /var/ldap/ldap_client_file 
#
# Do not edit this file manually; your changes will be lost.Please use ldapclient (1M) instead.
#
NS_LDAP_FILE_VERSION= 2.0
NS_LDAP_SERVERS= ldaptesting.example.com
NS_LDAP_SEARCH_BASEDN= o=test
NS_LDAP_AUTH= simple
NS_LDAP_SEARCH_SCOPE= sub
NS_LDAP_CACHETTL= 30
NS_LDAP_PROFILE= default
NS_LDAP_CREDENTIAL_LEVEL= proxy
NS_LDAP_SERVICE_SEARCH_DESC= passwd:ou=users,o=test?sub
NS_LDAP_SERVICE_SEARCH_DESC= shadow:ou=users,o=test?sub
NS_LDAP_SERVICE_SEARCH_DESC= group:ou=groups,o=test?sub
NS_LDAP_SERVICE_SEARCH_DESC= netgroup:ou=netgroups,o=test?sub
```
